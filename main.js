let savedDecks=JSON.parse(localStorage.getItem("metaphorDecks"))||[],currentDeck=null,isBackVisible=!0,shuffledDeck=[],currentModalIndex=-1,modalSource="none";const defaultDeck={name:"Комнаты души",backImage:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/back.webp",cards:[{title:"Гора",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/1.webp",description:"Символ цели, вызова и преодоления."},{title:"Заря",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/2.webp",description:"Пробуждение нового начала."},{title:"Росток",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/3.webp",description:"Первый шаг к переменам."},{title:"Мост",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/4.webp",description:"Связь между «там» и «здесь»."},{title:"Фонарь",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/5.webp",description:"Свет, ведущий сквозь неизвестность."},{title:"Компас",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/6.webp",description:"Внутреннее направление."},{title:"Зеркало",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/7.webp",description:"Увидеть себя настоящим."},{title:"Дверь",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/8.webp",description:"Возможность войти или выйти."},{title:"Семя",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/9.webp",description:"Потенциал, ожидающий своего времени."},{title:"Парус",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/10.webp",description:"Движение по ветру перемен."},{title:"Окошко",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/11.webp",description:"Взгляд за пределы привычного."},{title:"Камень",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/12.webp",description:"То, что можно обойти или поднять."},{title:"Корень",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/13.webp",description:"То, что держит, даже когда невидимо."},{title:"Лестница",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/14.webp",description:"Путь вверх — шаг за шагом."},{title:"Ключница",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/15.webp",description:"Хранительница многих возможностей."},{title:"Ручей",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/16.webp",description:"Мягкая сила, прокладывающая путь."},{title:"Часы",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/17.webp",description:"Время как ресурс и ограничение."},{title:"Крылья",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/18.webp",description:"Свобода или готовность к полёту."},{title:"Сундук",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/19.webp",description:"То, что спрятано, но не потеряно."},{title:"След",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/20.webp",description:"Путь, уже пройденный — или ещё нет?"},{title:"Остров",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/21.webp",description:"Уединение как выбор или испытание."},{title:"Звезда",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/22.webp",description:"Ориентир в темноте."},{title:"Нить",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/23.webp",description:"Связь, которую можно потерять или найти."},{title:"Огонь",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/24.webp",description:"То, что греет — и то, что сжигает."},{title:"Тень",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/25.webp",description:"То, что следует за нами — и чему мы не даём имя."},{title:"Сердце",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/26.webp",description:"Центр чувств и решений."},{title:"Колокол",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/27.webp",description:"Звон, пробуждающий внимание."},{title:"Песочные часы",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/28.webp",description:"Время течёт — но не исчезает бесследно."},{title:"Ворота",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/29.webp",description:"Рубеж между мирами."},{title:"Луна",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/30.webp",description:"Скрытая сторона сознания."},{title:"Якорь",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/31.webp",description:"Стабильность в бурю — или груз прошлого?"},{title:"Книга",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/32.webp",description:"История, которую можно открыть."},{title:"Радуга",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/33.webp",description:"Надежда после дождя."},{title:"Путь",image:"https://raw.githubusercontent.com/Kuetama/metaphorical-cards/main/koloda1/34.webp",description:"Не цель, а сам процесс движения."}]};function renderDeckList(){const e=document.getElementById("decksList");e&&(e.innerHTML=savedDecks.map((e,t)=>`\n      <div class="deck-item" data-index="${t}">\n        <span class="deck-name">${e.name}</span>\n        <br>\n        <button class="glow-on-hover select-btn">Выбрать</button>\n        ${t>0?'<button class="delete-btn danger">Удалить</button>':""}\n      </div>\n    `).join(""),e.onclick=e=>{const t=e.target.closest(".deck-item");if(!t)return;const a=parseInt(t.dataset.index);e.target.classList.contains("select-btn")?selectDeck(a):e.target.classList.contains("delete-btn")&&deleteDeck(a)})}function selectDeck(e){currentDeck=savedDecks[e],shuffledDeck=[...currentDeck.cards].sort(()=>Math.random()-.5),document.getElementById("deckInfo").textContent=`Активна: ${currentDeck.name}`,showAllCards()}function deleteDeck(e){0!==e&&confirm("Удалить колоду?")&&(savedDecks.splice(e,1),localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks)),renderDeckList(),currentDeck===savedDecks[e]&&(currentDeck=null,clearTable()))}function showAllCards(){if(!currentDeck)return;const e=document.getElementById("cardsContainer");e.innerHTML="",shuffledDeck.forEach((t,a)=>{if(isBackVisible){const n=document.createElement("div");n.className="card",n.style.position="relative",n.style.perspective="1000px";const o=document.createElement("div");o.style.transition="transform 0.6s",o.style.transformStyle="preserve-3d",o.style.position="absolute",o.style.width="100%",o.style.height="100%",o.style.top="0",o.style.left="0";const d=document.createElement("div");d.style.position="absolute",d.style.width="100%",d.style.height="100%",d.style.backfaceVisibility="hidden",d.style.borderRadius="8px",d.style.overflow="hidden";const c=document.createElement("img");c.src=currentDeck.backImage,c.alt="Рубашка",c.style.width="100%",c.style.height="100%",c.style.objectFit="cover",d.appendChild(c);const i=document.createElement("div");i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.backfaceVisibility="hidden",i.style.transform="rotateY(180deg)",i.style.borderRadius="8px",i.style.overflow="hidden",i.innerHTML=`<img src="${t.image}" alt="${t.title}" style="width:100%;height:100%;object-fit:cover;">`,o.appendChild(d),o.appendChild(i),n.appendChild(o),n.onclick=()=>{n.dataset.flipped?(modalSource="table",currentModalIndex=a,showCardModal(t,a)):(n.dataset.flipped="true",o.style.transform="rotateY(180deg)",setTimeout(()=>{modalSource="table",currentModalIndex=a,showCardModal(t,a)},300))},e.appendChild(n)}else{const n=document.createElement("div");n.className="card",n.innerHTML=`<img src="${t.image}" alt="${t.title}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`,n.style.cursor="pointer",n.style.boxShadow="0 4px 8px rgba(0,0,0,0.2)",n.onclick=()=>{modalSource="table",currentModalIndex=a,showCardModal(t,a)},e.appendChild(n)}})}function showCardModal(e,t){const a=document.getElementById("modal"),n=document.getElementById("modalTitle"),o=document.getElementById("modalImage"),d=document.getElementById("modalDesc"),c=document.getElementById("modalPrev"),i=document.getElementById("modalNext");n.textContent=e.title,o.src=e.image,d.textContent=e.description,o.classList.remove("hidden"),d.classList.add("hidden"),"table"===modalSource?(c.classList.toggle("hidden",t<=0),i.classList.toggle("hidden",t>=shuffledDeck.length-1),currentModalIndex=t):(c.classList.add("hidden"),i.classList.add("hidden")),a.classList.remove("hidden")}function closeModal(){document.getElementById("modal").classList.add("hidden"),currentModalIndex=-1,modalSource="none"}function navigateModal(e){if("table"!==modalSource||-1===currentModalIndex)return;const t=currentModalIndex+e;t>=0&&t<shuffledDeck.length&&(currentModalIndex=t,showCardModal(shuffledDeck[t],t))}function showRandomCard(){if(!currentDeck)return alert("Нет активной колоды!");const e=currentDeck.cards[Math.floor(Math.random()*currentDeck.cards.length)];document.getElementById("modalTitle").textContent=e.title,document.getElementById("modalImage").src=e.image.trim(),document.getElementById("modalText").textContent=e.description,document.getElementById("modalImage").style.display="block",document.getElementById("modalText").style.display="block",document.getElementById("modalThree").style.display="none",document.getElementById("modalPrev").classList.add("hidden"),document.getElementById("modalNext").classList.add("hidden"),document.getElementById("modal").classList.remove("hidden"),modalSource="random"}function showThreeRandomCards(){if(!currentDeck)return alert("Нет активной колоды!");const e=currentDeck.cards,t=[];for(;t.length<3&&t.length<e.length;){const a=Math.floor(Math.random()*e.length);t.includes(a)||t.push(a)}const a=t.map(t=>{const a=e[t];return`<div class="card-preview">\n      <img src="${a.image.trim()}" alt="${a.title}">\n      <div class="card-preview__title">${a.title}</div>\n      <div class="card-preview__description">${a.description}</div>\n    </div>`}).join("");document.getElementById("modalTitle").textContent="Три карты",document.getElementById("modalThree").innerHTML=`<div class="three-cards">${a}</div>`,document.getElementById("modalImage").style.display="none",document.getElementById("modalText").style.display="none",document.getElementById("modalThree").style.display="block",document.getElementById("modalPrev").classList.add("hidden"),document.getElementById("modalNext").classList.add("hidden"),document.getElementById("modal").classList.remove("hidden"),modalSource="three"}function showCardModal(e,t){document.getElementById("modalTitle").textContent=e.title,document.getElementById("modalImage").src=e.image.trim(),document.getElementById("modalText").textContent=e.description,document.getElementById("modalImage").style.display="block",document.getElementById("modalText").style.display="block",document.getElementById("modalThree").style.display="none","table"===modalSource?(document.getElementById("modalPrev").classList.toggle("hidden",t<=0),document.getElementById("modalNext").classList.toggle("hidden",t>=shuffledDeck.length-1),currentModalIndex=t):(document.getElementById("modalPrev").classList.add("hidden"),document.getElementById("modalNext").classList.add("hidden")),document.getElementById("modal").classList.remove("hidden")}function shuffleOnTable(){const e=document.getElementById("cardsContainer"),t=Array.from(e.children);if(0===t.length)return alert("Нет карт!");if(e.classList.contains("shuffling"))return;e.classList.add("shuffling");const a=t.map(e=>e.getBoundingClientRect()),n=[...t].sort(()=>Math.random()-.5);e.replaceChildren(...n);const o=t.map(e=>e.getBoundingClientRect());t.forEach((e,t)=>{const n=a[t].left-o[t].left,d=a[t].top-o[t].top;e.style.transform=`translate(${n}px, ${d}px)`,e.style.transition="none"}),e.offsetHeight,t.forEach(e=>{e.style.transition="transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1)",e.style.transform="translate(0, 0)"}),setTimeout(()=>{t.forEach(e=>{e.style.transition="",e.style.transform=""}),e.classList.remove("shuffling")},700)}function clearTable(){document.getElementById("cardsContainer").innerHTML="",document.getElementById("deckInfo").textContent="Стол очищен"}function toggleBack(){isBackVisible=!isBackVisible,document.getElementById("toggleBackBtn").textContent=isBackVisible?"Рубашка: ВКЛ":"Рубашка: ВЫКЛ",currentDeck&&showAllCards()}0===savedDecks.length&&(savedDecks=[defaultDeck],localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks))),document.addEventListener("DOMContentLoaded",()=>{renderDeckList(),document.getElementById("loadDeckBtn")?.addEventListener("click",()=>{document.getElementById("fileInput")?.click()}),document.getElementById("howToBtn")?.addEventListener("click",()=>{window.location.href="how-to.html"}),document.getElementById("show1Btn")?.addEventListener("click",showRandomCard),document.getElementById("show3Btn")?.addEventListener("click",showThreeRandomCards),document.getElementById("shuffleBtn")?.addEventListener("click",shuffleOnTable),document.getElementById("clearBtn")?.addEventListener("click",clearTable),document.getElementById("toggleBackBtn")?.addEventListener("click",toggleBack),document.getElementById("closeModal")?.addEventListener("click",closeModal),document.getElementById("modalPrev")?.addEventListener("click",()=>navigateModal(-1)),document.getElementById("modalNext")?.addEventListener("click",()=>navigateModal(1)),document.getElementById("fileInput")?.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{try{const t=JSON.parse(e.target.result);if(!t.name||!Array.isArray(t.cards)||0===t.cards.length)throw new Error("Неверный формат");savedDecks.push(t),localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks)),renderDeckList(),alert("Колода добавлена!")}catch(e){alert("❌ Ошибка: "+e.message)}},a.readAsText(t),e.target.value=""});let e=0;document.getElementById("modal")?.addEventListener("touchstart",t=>{"table"===modalSource&&(e=t.changedTouches[0].screenX)}),document.getElementById("modal")?.addEventListener("touchend",t=>{if("table"!==modalSource)return;const a=t.changedTouches[0].screenX,n=e-a;Math.abs(n)>50&&navigateModal(n>0?1:-1)})});const CACHE_NAME="metaphor-cards-v1",urlsToCache=["/","/index.html","/style.css","/app.js","/how-to.html","/icon-192.png","/icon-512.png"];self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(e=>e.addAll(urlsToCache)))}),self.addEventListener("fetch",e=>{e.respondWith(caches.match(e.request).then(t=>t||fetch(e.request)))});